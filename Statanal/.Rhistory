knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(notame)
library(FELLA)
library(xml2)
library(lemon)
library(cowplot)
library(readxl)
library(gridExtra)
library(svglite)
library(reshape2)
library(doParallel)
registerDoParallel(cores=4)
library(notameViz)
COMB <- import_from_excel(file = "/Users/cid/Documents/Erik_Genesis_Project/EVE/EVE/3_metab/data/neo_combined_area.xlsx", sheet = 1,
corner_row = 7, corner_column = 5,
split_by = c("Column", "Ion Mode"))
COMB <- import_from_excel(file = "./input/comb_data.xlsx", sheet = 1,
corner_row = 7, corner_column = 5,
split_by = c("Column", "Ion Mode"))
COMB <- import_from_excel(file = "./input/comb_data.xlsx", sheet = 1,
corner_row = 5, corner_column = 5,
split_by = c("Column", "Ion Mode"))
COMB <- import_from_excel(file = "./input/comb_data.xlsx", sheet = 1,
corner_row = 5, corner_column = 6,
split_by = c("Column", "Ion Mode"))
modes <- fix_object(COMB, split_data = TRUE)
names(modes)
# Initialize empty list for processed objects
processed <- list()
for (i in seq_along(modes)) {
name <- names(modes)[i]
mode <- modes[[i]]
# Set all zero abundances to NA
mode <- mark_nas(mode, value = 0)
# Flag features with low detection rate
mode <- flag_detection(mode, qc_limit = 0.7, group_limit = 0.8)
# Visualize data before drift correction
# Correct drift
corrected <- correct_drift(mode)
# Visualize data after drift correction
# Flag low-quality features
corrected <- corrected %>%
assess_quality() %>%
flag_quality()
# Visualize data after removal of low-quality features
# Save result of iteration
processed[[i]] <- corrected
}
merged <- merge_notame_sets(processed)
merged_no_qc <- drop_qcs(merged)
set.seed(2024)
imputed <- impute_rf(merged_no_qc)
base <- merged_no_qc
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
renv::install("bioc::notameStats")
View(merged_no_qc)
View(merged_no_qc@elementMetadata@listData)
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
library(notameStat)
library(notameStats)
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
assay(base)
View(assay(base))
View(assay(merged))
# Initialize empty list for processed objects
processed <- list()
for (i in seq_along(modes)) {
name <- names(modes)[i]
mode <- modes[[i]]
# Set all zero abundances to NA
mode <- mark_nas(mode, value = 0)
# Flag features with low detection rate
mode <- flag_detection(mode, qc_limit = 0.2, group_limit = 0.2)
# Visualize data before drift correction
# Correct drift
corrected <- correct_drift(mode)
# Visualize data after drift correction
# Flag low-quality features
corrected <- corrected %>%
assess_quality() %>%
flag_quality()
# Visualize data after removal of low-quality features
# Save result of iteration
processed[[i]] <- corrected
}
merged <- merge_notame_sets(processed)
merged_no_qc <- drop_qcs(merged)
merged_no_qc <- drop_qcs(merged)
View(assay(merged_no_qc))
set.seed(2024)
imputed <- impute_rf(merged_no_qc)
base <- impute_rf(merged_no_qc, all_features = TRUE)
base <- imputed
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
base <- impute_rf(imputed, all_features = TRUE)
View(assay(base))
View(base)
View(base@colData@listData)
base@colData@listData
COMB <- import_from_excel(file = "./input/comb_data.xlsx", sheet = 1,
corner_row = 5, corner_column = 6,
split_by = c("Column", "Ion Mode"))
modes <- fix_object(COMB, split_data = TRUE)
names(modes)
# Initialize empty list for processed objects
processed <- list()
for (i in seq_along(modes)) {
name <- names(modes)[i]
mode <- modes[[i]]
# Set all zero abundances to NA
mode <- mark_nas(mode, value = 0)
# Flag features with low detection rate
mode <- flag_detection(mode, qc_limit = 0.2, group_limit = 0.2)
# Visualize data before drift correction
# Correct drift
corrected <- correct_drift(mode)
# Visualize data after drift correction
# Flag low-quality features
corrected <- corrected %>%
assess_quality() %>%
flag_quality()
# Visualize data after removal of low-quality features
# Save result of iteration
processed[[i]] <- corrected
}
merged <- merge_notame_sets(processed)
merged_no_qc <- drop_qcs(merged)
set.seed(2024)
imputed <- impute_rf(merged_no_qc)
base <- impute_rf(imputed, all_features = TRUE)
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
base <- imputed
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
base <- join_rowData(base, lm_results)
View(base)
write_to_excel(base, file = paste0(ppath, "results.xlsx"))
write_to_excel(base, file = paste0("./", "results.xlsx"))
assay(base)
lm_results
get_final_list <- function(input, refer) {
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer$feature_data, tmp)
posn <- nrow(refer$feature_data %>% subset(Split == "RP_POS"))
tmp_pos <- tmp %>% subset(Split == "RP_POS")
tmp_neg <- tmp %>% subset(Split == "RP_NEG") %>% mutate(Alignment_ID = Alignment_ID - posn)
out <- list(tmp_pos, tmp_neg)
names(out) <- c("POS", "NEG")
return(out)
}
lm_results$Feature_ID
test <- get_final_list(lm_results, COMB)
input <- lm_results
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
View(tm[])
View(tmp)
input <- lm_results
refer <- COMB
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer$feature_data, tmp)
View(tmp)
View(COMB)
View(assay(COMB))
View(assay(lm_results))
View(lm_results)
assay(merged)
View(COMB)
data.frame(one = COMB@elementMetadata@listData$Feature_ID, two =COMB@elementMetadata@listData$Molecule_Name)
tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(one = COMB@elementMetadata@listData$Feature_ID, two =COMB@elementMetadata@listData$Molecule_Name)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
# tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
# tmp <- merge(refer, tmp)
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
refer$Molecule_names <- substr(refer$data,1,nchar(refer$data)-3)
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- substr(refer$data,1,nchar(refer$data)-3)
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
gsub('.{3}$', '', cs)
gsub('.{3}$', '', refer$Molecule_names)
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
gsub('.{3}$', '', refer$Molecule_names)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
keggtrans <- read_table(file = "./name2kegg.txt", sep = '\t')
keggtrans <- read_table(file = "./name2kegg.txt")
keggtrans
?read_table
?read_table2
keggtrans <- read.table(file = "./kegg2trans.txt", header = T, sep = "\t", quote ="")
keggtrans <- read.table(file = "./name2kegg.txt", header = T, sep = "\t", quote ="")
keggtrans
?merge
refer <- merge(refer, keggtrans, by.x = "Molecule_name", by.y = "Query")
refer <- merge(refer, keggtrans, by.x = "Molecule_names", by.y = "Query")
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Alignment_ID = COMB@elementMetadata@listData$Alignment_ID ,Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
refer <- merge(refer, keggtrans, by.x = "Molecule_names", by.y = "Query")
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(Feature_ID = COMB@elementMetadata@listData$Feature_ID, Alignment_ID = COMB@elementMetadata@listData$Alignment_ID ,Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
refer <- merge(refer, data.frame( Molecule_names = keggtrans$Query, KEGG = keggtrans$KEGG))
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(Alignment_ID = COMB@elementMetadata@listData$Alignment_ID,
Feature_ID = COMB@elementMetadata@listData$Feature_ID,
Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
refer <- merge(refer, data.frame( Molecule_names = keggtrans$Query, KEGG = keggtrans$KEGG))
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
input <- lm_results
refer <- data.frame(Alignment_ID = COMB@elementMetadata@listData$Alignment_ID,
Feature_ID = COMB@elementMetadata@listData$Feature_ID,
Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
refer <- merge(refer, data.frame( Molecule_names = keggtrans$Query, KEGG = keggtrans$KEGG)) %>% relocate(Alignment_ID)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
tmp
final_out <- tmp
write_to_excel(final_out, file = paste0("./", "results.xlsx"))
final_out <- tmp
write.table(final_out, file = "./final_results.txt", sep = "\t", row.names = F)
library(tidyverse)
library(notame)
library(FELLA)
library(xml2)
library(lemon)
library(cowplot)
library(readxl)
library(gridExtra)
library(svglite)
library(reshape2)
library(notameViz)
library(doParallel)
registerDoParallel(cores=4)
COMB <- import_from_excel(file = "./input/comb_data.xlsx", sheet = 1,
corner_row = 5, corner_column = 6,
split_by = c("Column", "Ion Mode"))
modes <- fix_object(COMB, split_data = TRUE)
names(modes)
# Initialize empty list for processed objects
processed <- list()
for (i in seq_along(modes)) {
name <- names(modes)[i]
mode <- modes[[i]]
# Set all zero abundances to NA
mode <- mark_nas(mode, value = 0)
# Flag features with low detection rate
mode <- flag_detection(mode, qc_limit = 0.2, group_limit = 0.2)
# Visualize data before drift correction
# Correct drift
corrected <- correct_drift(mode)
# Visualize data after drift correction
# Flag low-quality features
corrected <- corrected %>%
assess_quality() %>%
flag_quality()
# Visualize data after removal of low-quality features
# Save result of iteration
processed[[i]] <- corrected
}
merged <- merge_notame_sets(processed)
merged_no_qc <- drop_qcs(merged)
set.seed(2024)
imputed <- impute_rf(merged_no_qc)
base <- impute_rf(imputed, all_features = TRUE)
base <- imputed
assay(base, "log") <- log(assay(base))
lm_results <- perform_lm(base, assay.type = "log",
formula_char = "Feature ~ Group")
base <- join_rowData(base, lm_results)
keggtrans <- read.table(file = "./name2kegg.txt", header = T, sep = "\t", quote ="")
input <- lm_results
refer <- data.frame(Alignment_ID = COMB@elementMetadata@listData$Alignment_ID,
Feature_ID = COMB@elementMetadata@listData$Feature_ID,
Molecule_names = COMB@elementMetadata@listData$Molecule_Name)
refer$Molecule_names <- gsub('.{3}$', '', refer$Molecule_names)
refer <- merge(refer, data.frame( Molecule_names = keggtrans$Query, KEGG = keggtrans$KEGG)) %>% relocate(Alignment_ID)
tmp <- data.frame(Feature_ID = input[,1], l2fc = log2(input[,9]/input[,2]+1), p = input[,14], FDR = input[,15])
tmp <- merge(refer, tmp)
final_out <- tmp
write.table(final_out, file = "./output/final_results.txt", sep = "\t", row.names = F)
write.table(final_out, file = "./output/final_results.txt", sep = "\t", row.names = F)
final_out <- tmp
write.table(final_out, file = "./output/final_results.txt", sep = "\t", row.names = F)
write_to_excel(base, file = paste0("./output/", "results.xlsx"))
write_to_excel(base, file = paste0("./output/", "lm_results.xlsx"))
